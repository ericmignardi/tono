
> tono@0.1.0 test
> jest tones.test.ts

  console.log
    {"requestId":"c92d71f7-530c-484d-ace9-ba159be6c2ef","method":"POST","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.683Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    Unexpected error: {"requestId":"c92d71f7-530c-484d-ace9-ba159be6c2ef","timestamp":"2025-11-24T17:50:20.803Z","error":"\nInvalid `prisma.tone.create()` invocation in\nC:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:87:36\n\n  84 });\n  85 \n  86 // Create the tone with the AI results\nâ†’ 87 const tone = await prisma.tone.create({\n       data: {\n         userId: \"cmidfzvnp0000udlkoa25xoq2\",\n         name: \"Test Tone\",\n         artist: \"Test Artist\",\n         description: \"Test Description\",\n         guitar: \"Test Guitar\",\n         pickups: \"Test Pickups\",\n         strings: \".010â€“.046\",\n         amp: \"Test Amp\",\n         aiNotes: undefined,\n     +   aiAmpSettings: JsonNullValueInput | Json\n       }\n     })\n\nArgument `aiAmpSettings` is missing.","stack":"PrismaClientValidationError: \nInvalid `prisma.tone.create()` invocation in\nC:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:87:36\n\n  84 });\n  85 \n  86 // Create the tone with the AI results\nâ†’ 87 const tone = await prisma.tone.create({\n       data: {\n         userId: \"cmidfzvnp0000udlkoa25xoq2\",\n         name: \"Test Tone\",\n         artist: \"Test Artist\",\n         description: \"Test Description\",\n         guitar: \"Test Guitar\",\n         pickups: \"Test Pickups\",\n         strings: \".010â€“.046\",\n         amp: \"Test Amp\",\n         aiNotes: undefined,\n     +   aiAmpSettings: JsonNullValueInput | Json\n       }\n     })\n\nArgument `aiAmpSettings` is missing.\n    at Nn (C:\\Users\\migna\\Documents\\tono\\node_modules\\@prisma\\client\\src\\runtime\\core\\errorRendering\\throwValidationException.ts:45:9)\n    at ei.throwValidationException [as handleRequestError] (C:\\Users\\migna\\Documents\\tono\\node_modules\\@prisma\\client\\src\\runtime\\RequestHandler.ts:202:7)\n    at ei.handleAndLogRequestError (C:\\Users\\migna\\Documents\\tono\\node_modules\\@prisma\\client\\src\\runtime\\RequestHandler.ts:174:12)\n    at ei.request (C:\\Users\\migna\\Documents\\tono\\node_modules\\@prisma\\client\\src\\runtime\\RequestHandler.ts:143:12)\n    at a (C:\\Users\\migna\\Documents\\tono\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:833:24)\n    at POST (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:87:18)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:88:22)"}

    [0m [90m 36 |[39m
     [90m 37 |[39m   [90m// Unexpected error - log full details but don't expose to client[39m
    [31m[1m>[22m[39m[90m 38 |[39m   console[33m.[39merror([32m'Unexpected error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m           [31m[1m^[22m[39m
     [90m 39 |[39m   [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 40 |[39m     {
     [90m 41 |[39m       error[33m:[39m [32m'Internal server error'[39m[33m,[39m[0m

      at error (lib/api/errorHandler.ts:38:11)
      at POST (app/api/tones/route.ts:115:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:88:22)

  console.error
    API Error: {"requestId":"40211f7c-fc3e-40f8-b2e1-33ee2fa79675","timestamp":"2025-11-24T17:50:20.823Z","error":"Unauthorized","stack":"APIError: Unauthorized\n    at POST (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:20:13)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:118:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at POST (app/api/tones/route.ts:115:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:118:22)

  console.log
    {"requestId":"9a2d9708-9461-41c3-b332-fa3fe13c9446","method":"POST","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.833Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    API Error: {"requestId":"9a2d9708-9461-41c3-b332-fa3fe13c9446","timestamp":"2025-11-24T17:50:20.836Z","error":"Invalid input data","stack":"APIError: Invalid input data\n    at POST (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:48:13)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:140:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at POST (app/api/tones/route.ts:115:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:140:22)

  console.log
    {"requestId":"ce08a879-bf34-4f97-bbcc-a88c6a1d32a8","method":"POST","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.846Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    API Error: {"requestId":"ce08a879-bf34-4f97-bbcc-a88c6a1d32a8","timestamp":"2025-11-24T17:50:20.853Z","error":"No remaining credits. Please upgrade your plan.","stack":"APIError: No remaining credits. Please upgrade your plan.\n    at C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:62:15\n    at Proxy._transactionWithCallback (C:\\Users\\migna\\Documents\\tono\\node_modules\\@prisma\\client\\src\\runtime\\getPrismaClient.ts:722:18)\n    at POST (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:54:5)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:183:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at POST (app/api/tones/route.ts:115:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:183:22)

  console.log
    {"requestId":"9b4e61d1-0d99-44c2-8b1d-aa66918bd0c6","method":"POST","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.864Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    API Error: {"requestId":"9b4e61d1-0d99-44c2-8b1d-aa66918bd0c6","timestamp":"2025-11-24T17:50:20.865Z","error":"Too many tone generation requests. Please slow down.","stack":"APIError: Too many tone generation requests. Please slow down.\n    at POST (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:32:13)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:224:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at POST (app/api/tones/route.ts:115:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:224:22)

  console.log
    {"requestId":"099e08df-2cb6-4688-9f03-422e8ed6fb27","method":"GET","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.908Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    API Error: {"requestId":"099e08df-2cb6-4688-9f03-422e8ed6fb27","timestamp":"2025-11-24T17:50:20.912Z","error":"Invalid query parameters","stack":"APIError: Invalid query parameters\n    at GET (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:154:13)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:251:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at GET (app/api/tones/route.ts:192:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:251:22)

  console.log
    {"requestId":"67e0bb72-4d3e-4310-8300-a7fd2768b28e","method":"GET","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.937Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    API Error: {"requestId":"67e0bb72-4d3e-4310-8300-a7fd2768b28e","timestamp":"2025-11-24T17:50:20.942Z","error":"Invalid query parameters","stack":"APIError: Invalid query parameters\n    at GET (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:154:13)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:274:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at GET (app/api/tones/route.ts:192:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:274:22)

  console.log
    {"requestId":"4c046a5e-38c0-4e71-a942-78321e27f770","method":"GET","path":"/api/tones","userId":"test-user-id","timestamp":"2025-11-24T17:50:20.992Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.log
    {"requestId":"0d15b5c3-6159-441b-bac4-0c28b649ea70","method":"GET","path":"/api/tones","userId":"user-1","timestamp":"2025-11-24T17:50:21.026Z","type":"request"}

      at log (lib/api/errorHandler.ts:59:11)

  console.error
    API Error: {"requestId":"0d15b5c3-6159-441b-bac4-0c28b649ea70","timestamp":"2025-11-24T17:50:21.031Z","error":"Invalid query parameters","stack":"APIError: Invalid query parameters\n    at GET (C:\\Users\\migna\\Documents\\tono\\app\\api\\tones\\route.ts:154:13)\n    at Object.<anonymous> (C:\\Users\\migna\\Documents\\tono\\__tests__\\integration\\api\\tones.test.ts:330:22)"}

    [0m [90m 23 |[39m
     [90m 24 |[39m   [36mif[39m (error [36minstanceof[39m [33mAPIError[39m) {
    [31m[1m>[22m[39m[90m 25 |[39m     console[33m.[39merror([32m'API Error:'[39m[33m,[39m [33mJSON[39m[33m.[39mstringify(logData))[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 26 |[39m     [36mreturn[39m [33mNextResponse[39m[33m.[39mjson(
     [90m 27 |[39m       {
     [90m 28 |[39m         error[33m:[39m error[33m.[39mmessage[33m,[39m[0m

      at error (lib/api/errorHandler.ts:25:13)
      at GET (app/api/tones/route.ts:192:26)
      at Object.<anonymous> (__tests__/integration/api/tones.test.ts:330:22)

FAIL __tests__/integration/api/tones.test.ts
  POST /api/tones
    Ã— creates a new tone with valid data (170 ms)
    âˆš returns 401 when user is not authenticated (14 ms)
    âˆš returns 400 when request body is invalid (12 ms)
    âˆš returns 403 when user has no credits remaining (17 ms)
    âˆš returns 429 when rate limit is exceeded (12 ms)
  GET /api/tones
    Ã— returns paginated list of user tones (48 ms)
    Ã— returns empty array when user has no tones (31 ms)
    âˆš respects pagination parameters (55 ms)
    Ã— only returns tones belonging to the authenticated user (32 ms)

  â— POST /api/tones â€º creates a new tone with valid data

    expect(received).toBe(expected) // Object.is equality

    Expected: 201
    Received: 500

    [0m [90m 88 |[39m     [36mconst[39m response [33m=[39m [36mawait[39m [33mPOST[39m(req)[33m;[39m
     [90m 89 |[39m
    [31m[1m>[22m[39m[90m 90 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m201[39m)[33m;[39m
     [90m    |[39m                             [31m[1m^[22m[39m
     [90m 91 |[39m
     [90m 92 |[39m     [36mconst[39m data [33m=[39m [36mawait[39m response[33m.[39mjson()[33m;[39m
     [90m 93 |[39m     [36mconst[39m tone [33m=[39m [36mawait[39m prisma[33m.[39mtone[33m.[39mfindUnique({[0m

      at Object.toBe (__tests__/integration/api/tones.test.ts:90:29)

  â— GET /api/tones â€º returns paginated list of user tones

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 251 |[39m     [36mconst[39m response [33m=[39m [36mawait[39m [33mGET[39m(req)[33m;[39m
     [90m 252 |[39m
    [31m[1m>[22m[39m[90m 253 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 254 |[39m
     [90m 255 |[39m     [36mconst[39m data [33m=[39m [36mawait[39m response[33m.[39mjson()[33m;[39m
     [90m 256 |[39m     expect(data[33m.[39mtones)[33m.[39mtoHaveLength([35m10[39m)[33m;[39m[0m

      at Object.toBe (__tests__/integration/api/tones.test.ts:253:29)

  â— GET /api/tones â€º returns empty array when user has no tones

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 274 |[39m     [36mconst[39m response [33m=[39m [36mawait[39m [33mGET[39m(req)[33m;[39m
     [90m 275 |[39m
    [31m[1m>[22m[39m[90m 276 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 277 |[39m     [36mconst[39m data [33m=[39m [36mawait[39m response[33m.[39mjson()[33m;[39m
     [90m 278 |[39m     expect(data[33m.[39mtones)[33m.[39mtoEqual([])[33m;[39m
     [90m 279 |[39m   })[33m;[39m[0m

      at Object.toBe (__tests__/integration/api/tones.test.ts:276:29)

  â— GET /api/tones â€º only returns tones belonging to the authenticated user

    expect(received).toBe(expected) // Object.is equality

    Expected: 200
    Received: 400

    [0m [90m 330 |[39m     [36mconst[39m response [33m=[39m [36mawait[39m [33mGET[39m(req)[33m;[39m
     [90m 331 |[39m
    [31m[1m>[22m[39m[90m 332 |[39m     expect(response[33m.[39mstatus)[33m.[39mtoBe([35m200[39m)[33m;[39m
     [90m     |[39m                             [31m[1m^[22m[39m
     [90m 333 |[39m     [36mconst[39m data [33m=[39m [36mawait[39m response[33m.[39mjson()[33m;[39m
     [90m 334 |[39m     expect(data[33m.[39mtones)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m 335 |[39m     expect(data[33m.[39mtones[[35m0[39m][33m.[39mname)[33m.[39mtoBe([32m'User 1 Tone'[39m)[33m;[39m[0m

      at Object.toBe (__tests__/integration/api/tones.test.ts:332:29)

Test Suites: 1 failed, 1 total
Tests:       4 failed, 5 passed, 9 total
Snapshots:   0 total
Time:        0.885 s, estimated 2 s
Ran all test suites matching tones.test.ts.
